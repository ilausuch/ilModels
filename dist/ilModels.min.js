ilModel=function(t){this.$sendException=function(t){throw new ilModelException("ilModel",t,this)},this.getField=function(t){return this.$class.getField(t)},this.updateFrom=function(t){if(this.isDestroyed("updateFrom"),void 0===this.$fields){this.$fields=[];for(var i in t)this.$fields.push(new ilModelField(i))}void 0===this.$data&&(this.$data={}),this.$fields.forEach(function(i){this.$data[i.name]=t[i.name]},this),this.$toVirtualObjectsAllFields(this)},this.copyTo=function(t,i){this.isDestroyed("copyTo"),void 0===t&&(t=this),this.$fields.forEach(function(e){i[e.name]=t[e.name]},this)},this.getRaw=function(t){void 0===t&&(t=this);var i={};return this.copyTo(t,i),i},this.equalTo=function(t){for(var i=0;i<this.$fields.length;i++){var e=this.$fields[i];if(t[e.name]!==this[e.name])return!1}return!0},this.compareTo=function(t){var i=this,e=[];return this.$fields.forEach(function(s){i[s.name]!==t[s.name]&&e.push(s.name)}),e},this.clone=function(){return this.isDestroyed("clone"),new this.classFnc(this)},this.getPk=function(){var t={},i=this;return this.$fields.forEach(function(e){e.pk&&(t[e.name]=i[e.name])}),t},this.checkPk=function(t){if(null!==t&&"object"!=typeof t)throw new ilModelException("ilModel","PK is not valid",t);var i=!0,e=this;return this.$fields.some(function(s){if(s.pk){if(void 0===t[s.name])throw new ilModelException("ilModel.checkPk","PK is not valid, requires "+s.name+" field",{thePk:t,theItem:e});if(t[s.name]!==e[s.name])return i=!1,!1}}),i},this.getPkHash=function(){return JSON.stringify(this.getPk())},this.validateFieldInternal=function(t,i,e){var s=this.getField(i);if(void 0===s)return!0;void 0===e&&(e=!0);try{return s.validate(t[s.name])}catch(t){if(e)throw t;return!1}},this.validateField=function(t,i){return this.validateFieldInternal(this,t,i)},this.validateSandboxField=function(t,i){return this.validateFieldInternal(this.$sandbox,t,i)},this.validateInternal=function(t,i){var e=[];if(void 0===i&&(i=!0),$this=this,this.$fields.some(function(i){if($this.$isNew&&i.auto&&void 0===t[i.name]||i.noValidate);else try{$this.validateFieldInternal(t,i.name)}catch(t){e.push(t)}}),e.length>0){if(i)throw new ilModelException("ilModel","Validation error",{object:t,errors:e});return!1}return!0},this.validate=function(t){return this.validateInternal(this,t)},this.validateSandbox=function(t){return this.validateInternal(this.$sandbox,t)},this.$toVirtualObjectsField=function(t,i){void 0!==i.virtual&&(void 0!==t.$data[i.name]?t.$virtualData[i.virtual.name]=i.virtual.toVirtual(t.$data[i.name],t):t.$virtualData[i.virtual.name]=void 0)},this.$toVirtualObjectsAllFields=function(t){this.$fields.forEach(function(i){this.$toVirtualObjectsField(t,i)},this)},this.$fromVirtualObjectsField=function(t,i){if(void 0!==i.virtual){void 0!==t.$virtualData[i.virtual.name]?t.$data[i.name]=i.virtual.fromVirtual(t.$virtualData[i.virtual.name],t):t.$data[i.name]=void 0;var e=this.$class.getAssociationsOfField(i);e.length>0&&e.forEach(function(t){this.$updateAssociation(t)},this)}},this.$fromVirtualObjectsAllFields=function(t){this.$fields.forEach(function(i){this.$fromVirtualObjectsField(t,i)},this)},this.prepareSandbox=function(){this.isDestroyed("sandbox"),this.$sandbox={$data:{},$virtualData:{},$owner:this};var t=this;return this.$fields.forEach(function(i){this.$sandbox.$data[i.name]=this.$data[i.name],void 0===this.$sandbox.$data[i.name]&&(this.$sandbox.$data[i.name]=i.byDefaultValue),Object.defineProperty(this.$sandbox,i.name,{get:function(){return this.$data[i.name]},set:function(e){if(i.readOnly)throw new ilModelException(this.$className,"Cannot modify a readOnly property on sandbox",{theField:i,theObject:this});this.$data[i.name]=e,i.virtual&&t.$toVirtualObjectsField(this,i)}}),void 0!==i.virtual&&Object.defineProperty(this.$sandbox,i.virtual.name,{get:function(){return this.$virtualData[i.virtual.name]},set:function(e){this.$virtualData[i.virtual.name]=e,t.$fromVirtualObjectsField(this,i)}})},this),this.$toVirtualObjectsAllFields(this.$sandbox),void 0!==this.onSandbox&&this.onSandbox(),this.$sandbox},this.sandboxChanges=function(){this.isDestroyed("sandboxChanges"),void 0===this.$sandbox&&this.$sendException("Sandbox not created, use prepareSandbox before"),this.$fromVirtualObjectsAllFields(this.$sandbox),this.validateSandbox();var t={raw:{},changes:{},countChanges:0};return this.$fields.forEach(function(i){t.raw[i.name]=$this.$sandbox[i.name],$this[i.name]!==$this.$sandbox[i.name]&&(t.changes[i.name]=$this.$sandbox[i.name],t.countChanges++)}),t},this.isSandboxChanged=function(){return this.isDestroyed("isSandboxChanged"),this.sandboxChanges().countChanges>0},this.$confirmedSaveData=function(t,i){if(this.$isNew){var e=!0;if(this.$fields.some(function(i){if(i.pk&&(void 0===t[i.name]||""===t[i.name]))return e=!1,!1}),!e)throw new ilModelException(this.$className,"Invalid pk in incoming data",{theObject:this,theIncommingData:t})}var s=this.$isNew;if(this.$isNew=!1,void 0!==t)for(var o in t)void 0!==this.getField(o)&&(this.$sandbox.$data[o]=t[o]);this.$confirmSandboxBasic(),this.$sandbox=void 0,s&&this.$class.$cache&&this.$class.$cache.autoInsert&&this.$cache.getCollection().add(this),this.postSave&&this.postSave(),i.ready(this)},this.$confirmSandboxBasic=function(){this.$isNew=!1,this.updateFrom(this.$sandbox),this.validate(),this.$toVirtualObjectsAllFields(this)},this.confirmSandbox=function(t){this.isDestroyed("confirmSandbox");var i=this,e=new ilModelPromise,s=this.sandboxChanges();return 0===s.countChanges?(e.ready(this),e):(t?t(s).then(function(t){i.$confirmedSaveData(t,e)},function(t){e.error(t)}):(this.$confirmSandboxBasic(),e.ready(this)),e)},this.save=function(t){this.isDestroyed("save");var i=this;return this.confirmSandbox(function(t){var e=new ilModelPromise,s=i.$class.$prepareQueryOptions(s);if(i.$isNew)s.dataProvider.create(t.changes).then(function(t){e.ready(t)},function(t){e.error(t)});else{var o=i.$class.$options.useReplaceInsteadModify,a="",n=t.changes;if(void 0!==s.useReplaceInsteadModify&&(o=s.useReplaceInsteadModify),o?(a="replace",n=t.raw):a="modify",void 0===s.dataProvider[a])throw new ilModelException(this.$className,"Operation "+a+" isn't defined on data provider",{theObject:this,theDataProvider:s.dataProvider});s.dataProvider[a](i.getPk(),n).then(function(t){e.ready(t)},function(t){e.error(t)})}return e})},this.remove=function(t){this.isDestroyed("remove");var i=new ilModelPromise,t=this.$class.$prepareQueryOptions(t),e=this;return this.$isNew?i.ready():t.dataProvider.remove(this.getPk()).then(function(t){e.destroy(),i.ready(e)},function(t){i.error(t)}),i},this.isDestroyed=function(t){if(this.$destroyed)throw new ilModelException(this.$className,"This function cannot be used because object is destroyed",{theObject:this,theFunction:t})},this.destroy=function(){this.$sandbox=void 0,this.$destroyed=!0;for(var t in this.$class.$cache.collections){var i=this.$class.$cache.collections[t];i.remove(this)}},this.searchAssociation=function(t){for(var i in this.$class.$associations)if(i===t)return this.$class.$associations[t];throw new ilModelException(this.$className,"Invalid association",{theAssocName:t})},this.getAssociation=function(t,i){var e=this.searchAssociation(t);return void 0!==this.$associations[t]?this.$associations[t]:(this.$associations[t]=e.get(this,i),this.$associations[t])},this.invalideAllAssociations=function(){for(var t in this.$class.$associations)this.invalideAssociation(t)},this.invalideAssociation=function(t){return this.searchAssociation(t),delete this.$associations[t],this.$associations[t]=void 0,delete this.$associationsCacheData[t],this.$associationsCacheData[t]=void 0,this.getAssociation(t,{forceReload:!0})},this.updateAssociationsBySrc=function(t){for(var i in this.$class.$associations){var e=this.$class.$associations[i];void 0!==t[e.associated]&&(this.$associations[i]=void 0,this.$associationsCacheData[i]=void 0,e.forceRawData(this,t[e.associated]))}},this.$setupClass=function(t){function i(t,i,e){void 0===t[i]&&(t[i]=e)}var e=this,s=t.fields,o=t.options,a=t.name;t.cache,t.dataProviders;if(void 0===s||!Array.isArray(s))throw new ilModelException(a,"fields must be an array specified on config",{theConfig:t});if(this.$className=a,this.$class=window[a],this.$class.$class=this.$class,this.$class.$className=a,void 0===o?this.$options={}:this.$options=o,this.$class.$options=this.$options,this.$fields=s,this.$class.$fields=s,this.$class.$context=t.context,this.$class.postConstructor=t.postConstructor,this.$class.$methods=t.methods,this.$class.$nextUid=0,this.$class.getNextUid=function(){var t=this.$nextUid;return this.$nextUid++,t},i(this.$options,"validateOnCreate",ilModelConfiguration.basics.validateOnCreate),i(this.$options,"validateOnCreateNew",ilModelConfiguration.basics.validateOnCreateNew),i(this.$options,"validateGenerateException",ilModelConfiguration.basics.validateGenerateException),i(this.$options,"defaultDataProvider",void 0),i(this.$options,"forceReload",ilModelConfiguration.dataProviders.forceReload),i(this.$options,"useReplaceInsteadModify",ilModelConfiguration.dataProviders.useReplaceInsteadModify),this.$fields.forEach(function(t){if(!("ilModelField"==typeof t||t instanceof ilModelField))throw new ilModelException(e.className,"Error checking field. It's not a ilModelField",t)}),t.cache){if(!t.cache.$isCache)throw new ilModelException(this.className,"Cache object is not a cache",{theCache:t.cache});this.$class.$cache=t.cache}else ilModelConfiguration.cache.createCacheByDefault&&(this.$class.$cache=new ilModelCache({}));if(void 0!==this.$class.$cache&&(this.$cache=this.$class.$cache,this.$cache.init(this.$class)),this.$class.getCollection=function(t){return this.$class.$cache.getCollection(t)},this.$class.$dataProviders={},t.dataProviders){this.$dataProviders=this.$class.$dataProviders;var n=!0;for(var r in t.dataProviders){if(this.$class.$dataProviders[r]=t.dataProviders[r],void 0!==this.$class.$dataProviders[r].init)try{this.$class.$dataProviders[r].init(this.$class,r)}catch(t){throw new ilModelException("ilModel","Data provider "+r+" has an incorrect init function",{theDataProvider:this.$class.$dataProviders[r]})}n&&(void 0===this.$options.defaultDataProvider&&(this.$options.defaultDataProvider=r),n=!1)}}if(this.$class.getDataProvider=function(t){if(void 0!==this.$class.$dataProviders[t])return this.$class.$dataProviders[t];throw new ilModelException(this.$class.$className,"Dataprovider "+t+" doesn't exist")},t.associations){this.$class.$associations=t.associations;for(var l in this.$class.$associations){if(!(this.$class.$associations[l]instanceof ilModelAssociation))throw new ilModelException(this.$className,"Association is not an ilModelAssociation",{theAssociation:this.$class.$associations[l]});this.$class.$associations[l].setup(l,this.$class)}}if(this.$class.getField=function(t){for(var i=0;i<this.$fields.length;i++)if(this.$fields[i].name===t)return this.$fields[i]},t.synthetics&&(this.$class.$synthetics=t.synthetics),this.$class.$prepareQueryOptions=function(t){if(void 0===t&&(t={}),void 0===t.forceReload&&(t.forceReload=this.$options.forceReload),void 0===t.forceReload&&(t.forceReload=!1),void 0===t.dataProvider&&(t.dataProvider=this.$class.$options.defaultDataProvider),("string"==typeof t.dataProvider||t.dataProvider instanceof String)&&(t.dataProvider=this.$class.$dataProviders[t.dataProvider]),void 0===t.dataProvider)throw new ilModelException(e.$className,"There are no a data provider",t);return t},this.$class.extractPK=function(t){var i={};return e.$class.$fields.forEach(function(e){e.pk&&(i[e.name]=t[e.name])}),i},this.$class.createIfNotExist=function(t,i){void 0===i&&(i=!0);var s=e.$class.extractPK(t),o=e.$class.getCollection().get(s);return o?(i&&o.updateFrom(t),o.updateAssociationsBySrc(t)):o=new e.$class(t),o},this.$class.get=function(t,i){var e=new ilModelPromise({owner:this.$class,context:this.$class.$context});if(i=this.$prepareQueryOptions(i),i.forceReload)i.dataProvider.get(t,i).then(e);else{var s=this.getCollection().get(t);void 0!==s?e.ready(s):i.dataProvider.get(t,i).then(e)}return e},this.$class.all=function(t){var i=new ilModelPromise({owner:this.$class,context:this.$class.$context});t=this.$prepareQueryOptions(t);var e=this.$class.$cache.getCollection("all",{throwError:!1});return void 0===e||t.forceReload?this.$class.$cache.registerCollection("all",new ilModelCollection({promise:t.dataProvider.all(t).then(i)})):i.ready(e.data),i},this.$class.query=function(t,i){var e=new ilModelPromise({owner:this.$class,context:this.$class.$context});i=this.$prepareQueryOptions(i);var s=ilModelFieldQuery.toString(t),o=this.$class.$cache.getCollection(s,{throwError:!1});return void 0===o||i.forceReload?this.$class.$cache.registerCollection(s,new ilModelCollection({promise:i.dataProvider.query(t,i).then(e)})):e.ready(o.data),e},this.$class.getAssociationsOfField=function(t){var i=[];for(var e in this.$associations){var s=this.$associations[e];for(var o in s.by)if(t.name===o){i.push(s);break}}return i},this.$class.toModelArray=function(t){var i=[];return t.forEach(function(t){i.push(new window[a](t))}),i},void 0!==t.staticMethods)for(var l in t.staticMethods)this.$class[l]=t.staticMethods[l]},this.$setupObject=function(t){var i=this;if(this.$internalUid=this.$class.getNextUid(),this.$className=this.$class.$className,this.$data={},this.$virtualData={},this.$associations={},this.$associationsCacheData={},this.$setAndGet={locked:!1,lock:function(){this.locked=!0},unlock:function(){this.locked=!1}},this.$fields.forEach(function(t){if(t.name in this)throw new ilModelException(this.$className,"Duplicated property "+t.name,{theObject:this,theField:t});if(Object.defineProperty(this,t.name,{get:function(){return this.$data[t.name]},set:function(i){if(this.isDestroyed("set variable"),this.$setAndGet.locked)throw new ilModelException(this.$className,"Cannot modify "+t.name+" use $sandbox",{theValue:i});if(t.readOnly)throw new ilModelException(this.$className,"Cannot modify a readOnly property",{theField:t,theObject:this});this.$data[t.name]=i,void 0!==t.virtual&&this.$toVirtualObjectsField(this,t);var e=this.$class.getAssociationsOfField(t);e.length>0&&e.forEach(function(t){this.$updateAssociation(t)},this)}}),void 0!==t.virtual)try{Object.defineProperty(this,t.virtual.name,{get:function(){return this.$virtualData[t.virtual.name]},set:function(i){if(t.readOnly)throw new ilModelException(this.$className,"Cannot modify a readOnly property",{theField:t,theObject:this});if(this.$setAndGet.locked)throw new ilModelException(this.$className,"Cannot modify "+t.name+" use $sandbox",{theValue:i});this.$virtualData[t.virtual.name]=i,this.$fromVirtualObjectsField(this,t)}})}catch(i){throw new ilModelException(this.$className,"Cannot define a virtual variable, already declared",{theField:t.name,theFieldVirtual:t.virtual.name})}},this),this.$class.$associations){var e=[];for(var s in this.$class.$associations)e.push({name:s,assoc:this.$class.$associations[s]});e.forEach(function(t){i.$associationsCacheData[t.name]=void 0;try{Object.defineProperty(this,t.name,{get:function(){return this.getAssociation(t.name)},set:function(e){throw new ilModelException(i.$className,"Cannot modify an association",{theAssociation:t})}})}catch(e){throw new ilModelException(i.$className,"Cannot define an association variable, already declared",{theAssociation:t})}},this)}if(this.$class.$synthetics){var e=[];for(var o in this.$class.$synthetics)e.push({name:o,fnc:this.$class.$synthetics[o]});e.forEach(function(t){try{Object.defineProperty(this,t.name,{get:function(){return t.fnc(this)},set:function(e){throw new ilModelException(i.$className,"Cannot modify a synthetic field ",{theSynthetic:t})}})}catch(e){throw new ilModelException(i.$className,"Cannot define a syntetic variable, already declared",{theSyntetic:t})}},this)}if(this.$class.$methods)for(var a in this.$class.$methods)this[a]=this.$class.$methods[a];void 0!==this.$class.preConstructor&&this.$class.preConstructor(this),void 0===t?(this.$isNew=!0,this.prepareSandbox(),void 0!==this.onCreate&&this.onCreate(),this.$setAndGet.lock(),this.$options.validateOnCreateNew&&this.validate()):(this.$isNew=!1,this.updateFrom(t),this.updateAssociationsBySrc(t),this.$setAndGet.lock(),this.$options.validateOnCreate&&this.validate()),void 0!==this.onInit&&this.onInit(this.$isNew),!this.$isNew&&this.$class.$cache&&this.$class.$cache.autoInsert&&this.$cache.getCollection().add(this),void 0!==this.$class.postConstructor&&this.$class.postConstructor(this)},this.$setupClass(t)},ilModel.setup=function(t){if(void 0===t)throw new ilModelException("ilModel.setup","Confing is null");if(void 0===t.name)throw new ilModelException("ilModel.setup","name of class must be specified in config",{theConfig:t});void 0===t.context&&(t.context=ilModelConfiguration.defaultContext),void 0===t.defaults&&(t.defaults={}),window[t.name]=function(t){this.$setupObject(t)},window[t.name].prototype=new ilModel(t)},ilModelAssociation=function(t,i,e,s,o){this.type=t,this.associated=i,this.by=e,this.raw=void 0,this.options=o,this.fieldName=void 0,this.ownerClass=void 0,void 0===this.options&&(this.options={}),void 0===this.options.forceReload&&(this.options.forceReload=!1),this.setup=function(t,i){this.fieldName=t,this.ownerClass=i},this.get=function(t,i){if(void 0===i&&(i=this.options),void 0!==t.$associationsCacheData[this.fieldName]){if(!i.forceReload){var e=new ilModelPromise;return e.ready(t.$associationsCacheData[this.fieldName]),e}delete t.$associationsCacheData[this.fieldName],t.$associationsCacheData[this.fieldName]=void 0}var s={};for(var o in this.by){var a=this.by[o];s[a]=t[o]}if(void 0===window[this.associated])throw new ilModelException(this.ownerClass.$className,"Model "+this.associated+" not declared As model. Don't forget create the model or load it",{});if("one"===this.type)return window[this.associated].get(s,i);if("multiple"===this.type){var n=[];for(var r in s)n.push(ilModelFieldQuery.Equals(r,s[r]));void 0!==this.options.filter&&n.push(this.options.filter);var l=ilModelFieldQuery.And(n);return window[this.associated].query(l,i)}},this.forceRawData=function(t,i){if(void 0===window[this.associated])throw new ilModelException(this.ownerClass.$className,"Model "+this.associated+" not declared as model. Don't forget create the model or load it",{});if("one"===this.type)t.$associationsCacheData[this.fieldName]=window[this.associated].createIfNotExist(i);else{t.$associationsCacheData[this.fieldName]=[];var e=this;i.forEach(function(i){t.$associationsCacheData[e.fieldName].push(window[e.associated].createIfNotExist(i))})}}},ilModelAssociation.one=function(t,i,e){return new ilModelAssociation("one",t,i,void 0,e)},ilModelAssociation.multiple=function(t,i,e,s){return new ilModelAssociation("multiple",t,i,e,s)},ilModelCache=function(t){if(this.$isCache=!0,this.getCollection=function(t,i){if(void 0===t&&(t="global"),this.collections[t])return this.collections[t];if(void 0===i&&(i={}),void 0===i.throwError&&(i.throwError=!0),i.throwError!==!1)throw new ilModelException("ilModel.$cache","Collection "+t+" doesn't exist")},this.registerCollection=function(t,i){return this.collections[t]=i,i},this.init=function(t){this.parentClass=t},void 0===t)throw new ilModelException("ilModelCache","Invalid config",t);if(this.config=t,void 0===t.autoInsert?this.autoInsert=ilModelConfiguration.cache.autoInsert:this.autoInsert=t.autoInsert,this.collections={global:new ilModelCollection},void 0!==t.collections)for(var i in t.collections)this.registerCollection(i,t.collections[i])},ilModelCollection=function(t){if(this.data=[],this.updateEmitter=new ilModelEventsEmitter,void 0===t&&(t={}),t.updateFnc)this.auto=!0,this.ready=!1,void 0===t.preventReload&&(t.preventReload=ilModelConfiguration.cache.collections.preventReload);else if(this.auto=!1,this.ready=!0,void 0!==t.data&&(this.add(t.data),this.sort()),void 0!==t.promise){var i=this;t.promise.then(function(t){i.add(t),i.sort()})}this.config=t,this.sort=function(){void 0!==this.config.sortFnc&&this.data.sort(this.config.sortFnc)},this.$add=function(t){if(void 0===t)throw new ilModelException("ilModelCollection.add","Object to insert is undefined");try{var i=t.getPk()}catch(i){throw new ilModelException("ilModelCollection","Object to insert is not a ilModel",{theObject:t,theCollection:this})}var e=this.where(i);void 0===e?this.data.push(t):this.data[e]=t,this.sendUpdateEvent()},this.add=function(t){if(this.auto)throw new ilModelException("ilModelCollection","This is an automatic collection");Array.isArray(t)||t instanceof Array?t.forEach(function(t){this.$add(t)},this):this.$add(t)},this.remove=function(t){var i=this.where(t.getPk());void 0!==i&&(this.data.splice(i,1),this.sendUpdateEvent())},this.where=function(t){if(null!==t&&"object"!=typeof t)throw new ilModelException("ilModelCollection","PK is not valid",t);var i=void 0;return this.data.forEach(function(e,s){if(e.checkPk(t))return i=s,!0}),i},this.get=function(t){if(null!==t&&"object"!=typeof t)throw new ilModelException("ilModelCollection","PK is not valid",t);var i=void 0;return this.data.forEach(function(e){if(e.checkPk(t))return i=e,!0}),i},this.extract=function(t){var i=[];return this.data.forEach(function(e){t(e)&&i.push(e)}),i},this.extractCollection=function(t){var i=this,e=new ilModelCollection({updateFnc:function(e,s){e.ready(i.extract(t))}});return e.update(),this.updateEmitter.register(function(t){e.eventListener(t)}),e},this.$requireUpdate=function(){return!this.updated||!this.config.preventReload},this.eventListener=function(t){switch(t.type){case"update":this.update()}return!0},this.sendUpdateEvent=function(){this.updateEmitter.send({type:"update"})},this.update=function(){if(!this.auto)throw new ilModelException("ilModelCollection","This is not an automatic collection");if(void 0===this.config.updateFnc)throw new ilModelException("ilModelCollection","updateFnc not defined",{theCollection:this});var t=new ilModelPromise({owner:this,context:this.context}),i=this,e=new ilModelPromise;return e.then(function(e){i.data=e,i.sendUpdateEvent(),t.ready(e)},function(t){throw new ilModelException("ilModelCollection","Cannot update",{theColleciton:i})}),this.config.updateFnc(e),t},this.load=function(t,i){if(!this.auto)throw new ilModelException("ilModelCollection","This is not an automatic collection");void 0===i&&(i={});var e=new ilModelPromise({owner:this,context:this.context});if(i.forceReload||this.$requireUpdate()){this.ready=!1;var s=this,o=(new ilModelPromise).then(function(t){Array.isArray(t)||t instanceof Array?t.forEach(function(t){s.$add(t)},this):s.$add(t),s.ready=!0,e.ready(s.data)},function(t){e.error(t)});this.config.updateFnc(o,t),this.sendUpdateEvent()}else e.ready(this.data);return e},this.reload=function(t,i){return void 0===i&&(i={}),i.forceReload=!0,this.load(i)}},ilModelCollection.createAuto=function(t){return new ilModelCollection({updateFnc:t})},ilModelConfiguration={basics:{validateOnCreate:!0,validateOnCreateNew:!1,validateGenerateException:!0},dataProviders:{forceReload:!1,useReplaceInsteadModify:!1},cache:{createCacheByDefault:!0,autoInsert:!0,collections:{preventReload:!0}},defaultContext:{delayFnc:function(t){setTimeout(t)},http:void 0},setupDefaultAngularContext:function(t,i){ilModelConfiguration.defaultContext.http=new ilModelHttpAngular,ilModelConfiguration.defaultContext.http.setup({$http:t}),ilModelConfiguration.defaultContext.delayFnc=function(t){i(t)}}},ilModelDataProviderOData=function(t){void 0===t&&(t={}),void 0===t.context&&(t.context=ilModelConfiguration.defaultContext),this.config=t,this.url=t.url,this.context=t.context,this.init=function(t,i){this.parentClass=t,this.name=i},this.$preparePk=function(t){return void 0===this.config.pkMethod&&(this.config.pkMethod=ilModelDataProviderOData.PkMethods.firstField),this.config.pkMethod(t,this.parentClass)},this.$get=function(t,i){if(void 0===this.url||""===this.url)throw new ilModelException("ilModelDataProviderOData","You must complete the url definition "+this.name+" data provider in "+this.parentClass.$className+". Ejm: "+this.parentClass.$className+".$dataProviders."+this.name+'.url="<odata entity url>"');url=this.url;var e=new ilModelPromise;void 0!==t.pk&&t.queryString&&(url+=this.$preparePk(t.pk)),url+="?",void 0!==t.top&&(url=url+"$top="+t.top+"&"),void 0!==t.skip&&(url=url+"$skip="+t.skip+"&"),void 0!==t.expand&&(url=url+"$expand="+t.expand+"&"),void 0!==t.select&&(url=url+"$select="+t.select+"&"),void 0!==t.queryString&&(url=url+"$filter="+t.queryString+"&"),void 0!==t.orderby&&(void 0!==t.orderbyDesc&&t.orderbyDesc?url=url+"$orderby="+t.orderby+"desc &":url=url+"$orderby="+t.orderby+"&"),void 0!==t.operation&&(url=url+"$$op="+t.operation+"&"),this.config.debug&&console.debug("OData","call",o);var s=this,o={url:url,method:"GET"};return this.context.http.call(o).then(function(i){s.config.debug&&console.debug("OData","Raw result",i);var o=s.parentClass;if(t.isList){var a=i.value,n=[];a.forEach(function(t){n.push(o.createIfNotExist(t))}),t.first?e.ready(n[0]):e.ready(n)}else e.ready(o.createIfNotExist(i))},function(t){e.error(t)}),e},this.$call=function(t,i){var e=new ilModelPromise({owner:this}),s={method:t,url:this.url,headers:this.$headers};void 0!==i.pk&&(s.url=s.url+this.$preparePk(i.pk)),void 0!==i.data&&(s.data=i.data),this.debug&&console.debug("OData","call",s);var o=this;return this.context.http.call(s).then(function(t){if(o.debug&&console.debug("OData","Raw result",t),i.isList){var s=t.data.value,a=[];s.forEach(function(t){a.push(t)}),e.ready(a)}else e.ready(t)},function(t){t.statusText?e.error(t.statusText):e.error(t)}),e},this.prepareOptions=function(t,i){for(var e in i){var s=i[e],o=e.toLowerCase();switch(o){case"top":case"len":t.top=s;break;case"skip":case"init":t.skip=s;break;case"expand":t.expand=s;break;case"select":t.select=s;break;case"op":case"operation":t.operation=s;break;case"orderby":t.orderby=s;break;case"orderbydesc":t.orderbyDesc=s;break;case"querystring":t.queryString=s}}return t},this.get=function(t,i){var e=[];for(var s in t)e.push(new ilModelFieldQuery.Equals(s,t[s]));void 0!==i&&void 0!==i.filter&&e.push(i.filter);var o=ilModelFieldQuery.And(e);return this.$get(this.prepareOptions({queryString:ilModelDataProviderOData.toQueryString(this.parentClass,o),isList:!0,first:!0,top:1},i),i)},this.query=function(t,i){return this.$get(this.prepareOptions({queryString:ilModelDataProviderOData.toQueryString(this.parentClass,t),isList:!0},i),i)},this.all=function(t){return this.$get(this.prepareOptions({isList:!0},t))},this.create=function(t){return this.$call("POST",{data:t})},this.replace=function(t,i){return this.$call("PUT",{pk:t,data:i})},this.modify=function(t,i){return this.$call("PATCH",{pk:t,data:i})},this.remove=function(t){return this.$call("DELETE",{pk:t})}},ilModelDataProviderOData.toQueryString=function(t,i){switch(i.type){case"and":case"or":for(var e="",s=0;s<i.list.length-1;s++)e+=ilModelDataProviderOData.toQueryString(t,i.list[s])+" "+i.type+" ";return e+=ilModelDataProviderOData.toQueryString(t,i.list[s]);case"compare":var o=t.getField(i.fieldName);if(void 0===o)throw new ilModelException("ilModelDataProviderOData.toQueryString","Cannot find "+i.fieldName+" field in model",{theModel:t});var a=i.value;switch(o.type){case"string":a="'"+a+"'";break;case"guid":a="guid'"+a+"'"}var n="";switch(i.method){case"=":return i.fieldName+" eq "+a;case"<>":return i.fieldName+" ne "+a;case"<":return i.fieldName+" lt "+a;case"<=":return i.fieldName+" le "+a;case">":n=i.fieldName+" gt "+a;break;case">=":n=i.fieldName+" ge "+a;break;case"endswith":n="endswith("+i.fieldName+","+a+")";break;case"startswith":n="startswith("+i.fieldName+","+a+")";break;case"substringof":n="substringof("+i.fieldName+","+a+")";break;default:n=i.method}return 0+n}},ilModelDataProviderOData.PkMethods={v3:function(t,i){var e="(";for(var s in t){var o=t[s],a=void 0;if(i.$fields.some(function(t){if(t.name===s&&t.pk===!0)return a=t,!0}),void 0===a)throw new ilModelException("ilModelDataProviderOData","Field "+s+" is not a PK of "+i.$className);switch(e+=s+"=",a.type){case"guid":e+="guid'"+o+"'";break;case"int":case"float":e+=o;break;default:e+="'"+o+"'"}e+=","}return e.substr(0,e.length-1),e+=")"},firstField:function(t,i){var e="(";for(var s in t){var o=t[s],a=void 0;if(i.$fields.some(function(t){if(t.name===s&&t.pk===!0)return a=t,!0}),void 0===a)throw new ilModelException("ilModelDataProviderOData","Field "+s+" is not a PK of "+i.$className);switch(a.type){case"guid":e+="guid'"+o+"'";break;case"int":case"float":e+=o;break;default:e+="'"+o+"'"}break}return e+=")"}},ilModelEventsEmitter=function(){this.list=[],this.register=function(t){if("function"!=typeof t)throw new ilModelException("ilModelEventsEmitter.register","fnc is not a function",{theFnc:t});this.list.push(t)},this.send=function(t){for(var i=[],e=0;e<this.list.length;e++){var s=this.list[e];s(t)!==!1&&i.push(s)}this.list=i},this.length=function(){return this.list.length}},ilModelException=function(t,i,e){this.objectName=t,this.msg=i,this.details=e,window.lastException=this,this.toString=function(){return this.objectName+" "+this.msg+" - more details in lastException global variable"}},ilModelField=function(t,i,e){function s(t,i){return void 0!==t?t:i}switch(void 0===e&&(e={}),this.name=t,this.type=i,this.config=e,this.type.toLowerCase()){case"guid":this.type="guid";break;case"boolean":case"bool":this.type="boolean";break;case"int":case"integer":this.type="int";break;case"float":case"double":case"decimal":this.type="float";break;case"string":this.type="string";break;case"datetime":this.type="datetime";break;default:throw new ilModelException("ilModelField",this.type+" is not a valid type",{theFieldName:t,theFieldType:i,theConfig:e})}if(this.pk=s(e.pk,!1),this.readOnly=s(e.readOnly,!1),this.required=s(e.required,!1),this.noValidate=s(e.noValidate,!1),this.allowEmpty=s(e.allowEmpty,!0),this.maxLen=s(e.maxLen,0),this.auto=s(e.auto,!1),this.byDefaultValue=e.byDefault,this.validateFnc=e.validateFnc,void 0!==e.virtual?this.virtual=e.virtual:void 0!==e.derivated&&(this.virtual={name:e.derivated.name,toVirtual:e.derivated.toDerivated,fromVirtual:e.derivated.fromDerivated}),void 0!==this.virtual&&(void 0===this.virtual.name||void 0===this.virtual.toVirtual||void 0===this.virtual.fromVirtual))throw new ilModelException("ilModelField","Invalid virtural field configuration",{field:this});this.sendException=function(t,i){throw new ilModelException("ilModelField",t+" of "+this.name+"("+this.type+") = "+i,{field:this,value:i})},this.validateType=function(t){if(void 0===t)return!0;switch(this.type){case"guid":return(""+t).toUpperCase().match(/^[0-9A-F]{8}-[0-9A-F]{4}-[1][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i)||(""+t).toUpperCase().match(/^[0-9A-F]{8}-[0-9A-F]{4}-[2][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i)||(""+t).toUpperCase().match(/^[0-9A-F]{8}-[0-9A-F]{4}-[3][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i)||(""+t).toUpperCase().match(/^[0-9A-F]{8}-[0-9A-F]{4}-[4][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i)||(""+t).toUpperCase().match(/^[0-9A-F]{8}-[0-9A-F]{4}-[5][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i)||(""+t).toUpperCase().match(/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/);case"int":return t===parseInt(t);case"float":return null!==(""+t).match(/^\d+.?\d*$/);case"string":return"string"==typeof t||t instanceof String;case"datetime":return null!==(""+t).match(/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/);default:return!0}},this.validateNull=function(t){return!((void 0===t||null===t)&&(this.pk||this.required))},this.validate=function(t){var i=""+t;return""!==i||this.allowEmpty||this.sendException("Invalid empty value",t),void 0==t||null==t?(this.required&&this.sendException("Required value",t),
this.validateNull(t)||this.sendException("Invalid null or undefined value",t)):(this.validateType(t)||this.sendException("Invalid type",t),"string"===this.type&&this.maxLen>0&&i.length>this.maxLen&&this.sendException("Invalid string length",t),void 0===this.validateFnc||e.validateFnc(t,this)||this.sendException("Fails on validation function",t)),!0}},ilModelField.Configurations={ReadOnly:{required:!0,readOnly:!0,auto:!0},Pk:{pk:!0,required:!0,readOnly:!0,auto:!0}},ilModelFieldQuery={Equals:function(t,i,e){return ilModelFieldQuery.Compare("=",t,i,e)},NotEquals:function(t,i,e){return ilModelFieldQuery.Compare("<>",t,i,e)},LessThan:function(t,i,e){return ilModelFieldQuery.Compare("<",t,i,e)},LessOrEqualThan:function(t,i,e){return ilModelFieldQuery.Compare("<=",t,i,e)},GreaterThan:function(t,i,e){return ilModelFieldQuery.Compare(">",t,i,e)},GreaterOrEqualThan:function(t,i,e){return ilModelFieldQuery.Compare(">=",t,i,e)},Compare:function(t,i,e,s){return{type:"compare",method:t,fieldName:i,value:e,options:s}},Filter:function(t,i,e){return{type:"filter",method:t,fieldName:i,options:e}},And:function(t){return Array.isArray(t)||(t=[t]),{type:"and",list:t}},Or:function(t){return Array.isArray(t)||(t=[t]),{type:"or",list:t}},Not:function(t){return{type:"not",query:t}},toString:function(t){var i="";switch(t.type){case"and":case"or":i+=t.type+"(",t.list.forEach(function(t){i+=ilModelFieldQuery.toString(t)+","});break;case"compare":i+=t.fieldName+t.method+t.value;break;case"filter":i+=t.method+"("+t.fieldName+")"}return i}},ilModelHttpAngular=function(t){this.setup=function(t){if(void 0===t)throw new ilModelException("ilModelHttpAngular","Requires config in constructor");if(this.config=t,void 0===t.$http)throw new ilModelException("ilModelHttpAngular","Requires $http in constructor config",t);this.$http=t.$http,void 0===t.defaultErrorCallback&&(this.config.defaultErrorCallback=function(t){throw new ilModelException("ilModelHttpAngular","Error in a call",t)}),void 0===t.successCodes&&(t.successCodes=[200,201,204]),void 0===t.defaultHeaders&&(t.defaultHeaders={Accept:"application/json"}),this.$checkSuccess=function(t){var i=!1;return this.config.successCodes.some(function(e){if(e===t)return i=!0,!0}),i}},void 0!==t&&this.setup(t),this.call=function(t){var i=new ilModelPromise;if(void 0!==t.headers)var e=t.headers;else var e=this.config.defaultHeaders;if(void 0===t.method)var s="GET";else var s=t.method;if(void 0===t.url)throw new ilModelException("ilModelHttpAngular.call","url is required",t);var o={url:t.url,method:s,headers:e};void 0!==t.data&&(o.data=t.data);var a=this;return this.$http(o).then(function(t){a.$checkSuccess(t.status)?i.ready(t.data):i.error(t)},function(t){i.error(t)}),i}},ilModelPromise=function(t){this.$isPromise=!0,this.data=void 0,this.isLoading=!0,this.isError=!1,this.hasFinished=!1,this.successEmitter=new ilModelEventsEmitter,this.errorEmitter=new ilModelEventsEmitter,void 0===t&&(t={}),void 0===t.context?this.context=ilModelConfiguration.defaultContext:this.context=t.context,void 0!==t.owner&&(this.owner=t.owner),this.ready=function(t){this.data=t,this.isLoading=!1,this.hasFinished=!0;var i=this;this.context.delayFnc(function(){i.successEmitter.length()>0&&i.successEmitter.send(i.data)})},this.error=function(t){var i=this;this.hasFinished=!0,this.isLoading=!1,this.isError=!1,this.error=t,this.context.delayFnc(function(){if(!(i.errorEmitter.length()>0))throw new ilModelException("ilModelPromise","Error loading data",{theOwner:i.owner,error:t});i.errorEmitter.send(i.error)})},this.then=function(t,i){if(this.hasFinished){var e=this;this.context.delayFnc(function(){e.isError?t instanceof ilModelPromise||t instanceof ilModelPromiseSync?i.error(e.error):i(error):t instanceof ilModelPromise||t instanceof ilModelPromiseSync?t.ready(e.data):t(e.data)})}else t.$isPromise?(this.successEmitter.register(function(i){t.ready(i)}),this.errorEmitter.register(function(i){t.error(i)})):(this.successEmitter.register(t),void 0!=i&&null!=i&&this.errorEmitter.register(i));return this},void 0!==t.data&&this.ready(t.data)},ilModelPromiseSync=function(t){this.$isPromise=!0,this.isLoading=!0,this.isError=!1,this.hasFinished=!1,this.successEmitter=new ilModelEventsEmitter,this.errorEmitter=new ilModelEventsEmitter,void 0===t&&(t={}),void 0===t.context?this.context=ilModelConfiguration.defaultContext:this.context=t.context,void 0!==t.owner&&(this.owner=t.owner),this.syncList=[],this.addTask=function(t,i){var e=this.add(i);t(e)},this.add=function(t){this.isLoading=!0,this.hasFinished=!1,void 0===t&&(t={});var i={$isPromise:!0,id:this.syncList.length,options:t,sync:this,isLoading:!0,isError:!1,hasFinished:!1,data:void 0,errorText:void 0,ready:function(t){if(this.hasFinished)throw new ilModelException("ilModelPromiseSync.object","This sync is already finished",{theSyncObject:this});this.hasFinished=!0,this.isLoading=!1,this.data=t,this.sync.ready(this)},error:function(t){if(this.hasFinished)throw new ilModelException("ilModelPromiseSync.object","This sync is already finished",{theSyncObject:this});this.hasFinished=!0,this.isLoading=!1,this.isError=!0,this.errorText=t,this.sync.ready(this)}};return this.syncList.push(i),i},this.ready=function(t){var i=!0;if(this.syncList.some(function(t){if(!t.hasFinished)return i=!1,!1}),i){this.isLoading=!1,this.hasFinished=!0;var e=!1;if(this.syncList.some(function(t){if(t.isError)return e=!0,!0}),e){var s=this;this.context.delayFnc(function(){if(!(s.errorEmitter.length()>0))throw new ilModelException("ilModelPromise","Error loading data",{theOwner:s.owner,error:err});s.errorEmitter.send(s.syncList)})}else{var s=this;this.context.delayFnc(function(){s.successEmitter.length()>0&&s.successEmitter.send(s.syncList)})}}},this.then=function(t,i){if(this.hasFinished){var e=this;this.context.delayFnc(function(){e.isError?t instanceof ilModelPromise||t instanceof ilModelPromiseSync?i.error(e.error):i(e.errorText):t instanceof ilModelPromise||t instanceof ilModelPromiseSync?t.ready(e.data):t(e.data)})}else t.$isPromise?(this.successEmitter.register(function(i){t.ready(i)}),this.errorEmitter.register(function(i){t.error(i)})):(this.successEmitter.register(t),void 0!=i&&null!=i&&this.errorEmitter.register(i));return this},this.progress=function(){var t=0;return this.syncList.forEach(function(i){i.hasFinished&&t++}),{completed:t,total:this.syncList.length}}},ilModelValidations={email:function(t){return null!==t.match(/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)}};